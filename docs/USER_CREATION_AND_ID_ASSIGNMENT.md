# User Creation and ID Assignment

## Overview
This document explains where and how users are created in the system, and how User IDs are assigned.

---

## 1. User ID Assignment

### Database Level (SQL Server)
**Location**: `database/02-create-tables.sql`

```sql
CREATE TABLE Users (
    UserID INT PRIMARY KEY IDENTITY(1,1),  -- Auto-increment primary key
    Username NVARCHAR(50) NOT NULL,
    PasswordHash NVARCHAR(255) NOT NULL,
    CreatedDate DATETIME2 NOT NULL DEFAULT GETDATE(),
    Status NVARCHAR(20) NOT NULL DEFAULT 'active'
);
```

**How User ID is Generated**:
- `IDENTITY(1,1)` means SQL Server automatically generates the User ID
- Starts at 1 and increments by 1 for each new user
- The database handles this automatically - no manual assignment needed

### Entity Framework Level
**Location**: `backend-dotnet/DAFTech.DriverLicenseSystem.Api/Models/Entities/User.cs`

```csharp
public class User
{
    public int UserId { get; set; }  // Maps to UserID in database
    public string Username { get; set; } = string.Empty;
    public string PasswordHash { get; set; } = string.Empty;
    public DateTime CreatedDate { get; set; } = DateTime.Now;
    public string Status { get; set; } = "active";

    // Navigation properties
    public ICollection<Driver> RegisteredDrivers { get; set; } = new List<Driver>();
    public ICollection<VerificationLog> VerificationLogs { get; set; } = new List<VerificationLog>();
}
```

**How it works**:
- When you create a new `User` object, you don't set the `UserId`
- Entity Framework automatically gets the generated ID from the database after `SaveChangesAsync()`
- The ID is populated in the object after the insert operation

---

## 2. User Creation Methods

### Method 1: Database Seed Script (Initial Setup)
**Location**: `database/05-seed-data.sql`

```sql
-- Insert default users
INSERT INTO Users (Username, PasswordHash, Status)
VALUES 
    ('admin', 'PLACEHOLDER_HASH_UPDATE_REQUIRED', 'active'),
    ('officer1', 'PLACEHOLDER_HASH_UPDATE_REQUIRED', 'active'),
    ('officer2', 'PLACEHOLDER_HASH_UPDATE_REQUIRED', 'active');
```

**Process**:
1. Run `05-seed-data.sql` to create placeholder users
2. Run `fix-passwords.sql` to update with proper BCrypt hashes
3. User IDs are automatically assigned: admin=1, officer1=2, officer2=3

**Default Credentials**:
- Username: `admin` | Password: `Admin@123`
- Username: `officer1` | Password: `Officer@123`
- Username: `officer2` | Password: `Officer@123`

---

### Method 2: Direct SQL Insert (Manual)
**Location**: `database/add-admin-template.sql`

```sql
-- Template for adding new users manually
INSERT INTO Users (Username, PasswordHash, Status)
VALUES (
    'john.admin',                                    -- Username
    '$2a$11$PASTE_YOUR_GENERATED_HASH_HERE',        -- BCrypt hash
    'active'                                         -- Status
);
```

**Process**:
1. Generate BCrypt hash for password (see Method 4)
2. Insert user directly into database
3. User ID is auto-generated by SQL Server

---

### Method 3: Repository Create Method (Programmatic)
**Location**: `backend-dotnet/DAFTech.DriverLicenseSystem.Api/Repositories/UserRepository.cs`

```csharp
public class UserRepository
{
    private readonly ApplicationDbContext _context;

    public async Task<User> Create(User user)
    {
        _context.Users.Add(user);           // Add to context
        await _context.SaveChangesAsync();  // Save to database (ID is generated here)
        return user;                        // User object now has the generated UserId
    }
}
```

**How to use**:
```csharp
// Example usage in a service or controller
var newUser = new User
{
    Username = "newuser",
    PasswordHash = authService.HashPassword("Password@123"),
    Status = "active",
    CreatedDate = DateTime.Now
    // Don't set UserId - it will be auto-generated
};

var createdUser = await userRepository.Create(newUser);
// createdUser.UserId now contains the auto-generated ID
```

---

### Method 4: Password Hashing Service
**Location**: `backend-dotnet/DAFTech.DriverLicenseSystem.Api/Services/AuthenticationService.cs`

```csharp
public class AuthenticationService
{
    // Hash a plain text password
    public string HashPassword(string password)
    {
        return BCrypt.Net.BCrypt.HashPassword(password, BCrypt.Net.BCrypt.GenerateSalt());
    }
    
    // Verify a password against a hash
    public bool VerifyPassword(string password, string hash)
    {
        try
        {
            return BCrypt.Net.BCrypt.Verify(password, hash);
        }
        catch
        {
            return false;
        }
    }
}
```

**Usage**:
```csharp
// In a controller or service
var passwordHash = _authService.HashPassword("MyPassword@123");

// Create user with hashed password
var user = new User
{
    Username = "testuser",
    PasswordHash = passwordHash,
    Status = "active"
};
```

---

## 3. Current User Creation Flow

### There is NO User Registration Endpoint ❌

**Important**: The system currently does NOT have a public user registration endpoint.

**What's Missing**:
- No `POST /api/Auth/register` endpoint
- No `POST /api/User/create` endpoint
- No user self-registration feature
- No admin panel for creating users

**Current Endpoints**:
```csharp
// AuthController.cs - Only has login
[HttpPost("login")]
public async Task<ActionResult> Login([FromBody] LoginRequestDto request)
{
    // Validates existing users only
    // Cannot create new users
}
```

---

## 4. How to Create New Users (Current System)

### Option A: Using SQL Scripts (Recommended)

**Step 1**: Generate BCrypt hash using C# or online tool
```csharp
// Use this code snippet or create a console app
using BCrypt.Net;
var hash = BCrypt.HashPassword("YourPassword@123");
Console.WriteLine(hash);
// Output: $2a$11$xyz...abc
```

**Step 2**: Insert into database
```sql
USE DriverLicenseDB;

INSERT INTO Users (Username, PasswordHash, Status)
VALUES ('newuser', '$2a$11$xyz...abc', 'active');

-- Verify
SELECT * FROM Users WHERE Username = 'newuser';
```

### Option B: Using Entity Framework in Code

**Create a temporary endpoint or console app**:
```csharp
// In a controller (for testing only - remove in production)
[HttpPost("create-user-temp")]
public async Task<ActionResult> CreateUserTemp([FromBody] CreateUserDto request)
{
    var passwordHash = _authService.HashPassword(request.Password);
    
    var user = new User
    {
        Username = request.Username,
        PasswordHash = passwordHash,
        Status = "active",
        CreatedDate = DateTime.Now
    };
    
    var createdUser = await _userRepository.Create(user);
    
    return Ok(new { 
        userId = createdUser.UserId,  // Auto-generated ID
        username = createdUser.Username 
    });
}
```

---

## 5. User ID Usage in the System

### Where User ID is Retrieved

**From JWT Token** (Most Common):
```csharp
// In any controller with [Authorize] attribute
var userIdClaim = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
if (int.TryParse(userIdClaim, out int userId))
{
    // Use userId for operations
}
```

**Example in DriverController**:
```csharp
[HttpPost("register")]
[Authorize]
public async Task<ActionResult> RegisterDriver([FromBody] DriverRegistrationDto request)
{
    // Get user ID from JWT token
    var userIdClaim = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
    if (!int.TryParse(userIdClaim, out int userId))
    {
        return Unauthorized("Invalid user authentication");
    }
    
    // Use userId to track who registered this driver
    var driver = new Driver
    {
        LicenseId = request.LicenseId,
        FullName = request.FullName,
        RegisteredBy = userId,  // Foreign key to Users table
        // ... other fields
    };
    
    await _driverRepository.Create(driver);
}
```

### Where User ID is Stored as Foreign Key

**1. Drivers Table**:
```sql
CREATE TABLE Drivers (
    DriverID INT PRIMARY KEY IDENTITY(1,1),
    -- ... other fields
    RegisteredBy INT NOT NULL,  -- References Users.UserID
    FOREIGN KEY (RegisteredBy) REFERENCES Users(UserID)
);
```

**2. VerificationLogs Table**:
```sql
CREATE TABLE VerificationLogs (
    LogID INT PRIMARY KEY IDENTITY(1,1),
    LicenseID NVARCHAR(50) NOT NULL,
    VerificationStatus NVARCHAR(20) NOT NULL,
    CheckedBy INT NOT NULL,  -- References Users.UserID
    CheckedDate DATETIME2 NOT NULL DEFAULT GETDATE(),
    FOREIGN KEY (CheckedBy) REFERENCES Users(UserID)
);
```

---

## 6. User ID in JWT Token

### Token Generation
**Location**: `backend-dotnet/DAFTech.DriverLicenseSystem.Api/Helpers/JwtHelper.cs`

```csharp
public string GenerateToken(int userId, string username, ...)
{
    var claims = new[]
    {
        new Claim(ClaimTypes.NameIdentifier, userId.ToString()),  // User ID
        new Claim(ClaimTypes.Name, username),                     // Username
        new Claim(JwtRegisteredClaimNames.Sub, userId.ToString()),
        new Claim(JwtRegisteredClaimNames.Jti, Guid.NewGuid().ToString())
    };
    
    // ... create and return token
}
```

### Token Structure
```json
{
  "nameid": "1",              // User ID (ClaimTypes.NameIdentifier)
  "unique_name": "admin",     // Username
  "sub": "1",                 // Subject (also User ID)
  "jti": "guid-here",         // Token ID
  "exp": 1708257600,          // Expiration timestamp
  "iss": "DAFTechAPI",        // Issuer
  "aud": "DAFTechApp"         // Audience
}
```

---

## 7. Complete User Creation Example

### Full Code Example

```csharp
// Step 1: Create the user object (no UserId set)
var newUser = new User
{
    Username = "john.doe",
    PasswordHash = _authService.HashPassword("SecurePass@123"),
    Status = "active",
    CreatedDate = DateTime.Now
    // UserId is NOT set - will be auto-generated
};

// Step 2: Save to database
var createdUser = await _userRepository.Create(newUser);

// Step 3: User ID is now available
Console.WriteLine($"New user created with ID: {createdUser.UserId}");
// Output: New user created with ID: 4 (or next available ID)

// Step 4: Generate JWT token for the new user
var token = _authService.GenerateJwtToken(
    createdUser.UserId,
    createdUser.Username
);

// Step 5: Return to client
return Ok(new LoginResponseDto
{
    Token = token,
    UserId = createdUser.UserId,  // Auto-generated ID
    Username = createdUser.Username,
    ExpiresAt = DateTime.UtcNow.AddHours(24)
});
```

---

## 8. Summary

### User ID Assignment
✅ **Automatic** - SQL Server IDENTITY(1,1) auto-generates IDs
✅ **Sequential** - Starts at 1, increments by 1
✅ **No manual assignment needed** - Entity Framework handles it

### User Creation Locations
1. **Database Seed Script** - `database/05-seed-data.sql` (initial users)
2. **SQL Insert** - `database/add-admin-template.sql` (manual creation)
3. **Repository Method** - `UserRepository.Create()` (programmatic)
4. **No API Endpoint** - Currently no user registration endpoint

### User ID Usage
- Stored in JWT token claims
- Retrieved from `ClaimTypes.NameIdentifier`
- Used as foreign key in Drivers and VerificationLogs tables
- Tracks who performed actions (registered drivers, verified licenses)

### Current Limitations
❌ No user registration API endpoint
❌ No admin panel for user management
❌ No self-service user creation
❌ Must use SQL scripts or direct database access

### Recommendations
To add user management:
1. Create `UserController` with CRUD endpoints
2. Add `[Authorize(Roles = "admin")]` for protection
3. Implement user registration endpoint
4. Add user management UI in mobile app (admin only)

---

**Last Updated**: February 18, 2026
